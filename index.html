<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>User Panel</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@200..900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        neon: { pink: '#ff1493', blue: '#00ffff', purple: '#bf00ff', green: '#00ff88' },
                        dark: { bg: '#050507', card: '#12121a', glass: 'rgba(255,255,255,0.03)' }
                    },
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    animation: {
                        'fly': 'fly 3s linear infinite',
                        'pop': 'pop 0.3s ease-out forwards'
                    },
                    keyframes: {
                        fly: { '0%': { transform: 'translateX(-10px) translateY(5px) rotate(-10deg)', opacity: '0' }, '10%': { opacity: '1' }, '100%': { transform: 'translateX(50px) translateY(-20px) rotate(10deg)', opacity: '0' } },
                        pop: { '0%': { transform: 'scale(0.8)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #050507; color: #e0e0ff; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(20, 20, 30, 0.6); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3); }
        .glass-strong { background: rgba(10, 10, 15, 0.9); backdrop-filter: blur(20px); border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .input-box { background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); color: white; transition: 0.3s; }
        .input-box:focus { border-color: #00ffff; outline: none; box-shadow: 0 0 15px rgba(0,255,255,0.2); }
        ::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        .page-enter { animation: pop 0.4s ease-out; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden text-sm">

    <!-- HEADER -->
    <header class="h-16 glass z-40 flex items-center justify-between px-4 sticky top-0">
        <div class="flex items-center gap-2" id="site-identity">
            <!-- Injected via JS -->
            <div class="w-8 h-8 rounded bg-gradient-to-br from-neon-blue to-neon-pink flex items-center justify-center font-bold text-black font-sans">S</div>
            <span class="font-bold text-lg tracking-tight">SNR <span class="text-neon-blue">PANEL</span></span>
        </div>
        
        <div id="header-auth" class="flex items-center gap-3">
            <button onclick="nav('auth')" class="text-xs bg-white/10 px-3 py-1.5 rounded-full font-bold hover:bg-white/20">Login</button>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main id="main-content" class="flex-1 overflow-y-auto pb-24 scroll-smooth relative">
        <!-- Views -->
    </main>

    <!-- BOTTOM NAV -->
    <nav class="fixed bottom-0 w-full h-[70px] glass-strong z-50 flex justify-around items-center px-2 pb-2">
        <button onclick="nav('home')" class="nav-btn flex flex-col items-center gap-1 p-2 text-gray-400 hover:text-white transition" id="btn-home"><i class="fas fa-home text-xl"></i><span class="text-[10px]">Home</span></button>
        <button onclick="nav('orders')" class="nav-btn flex flex-col items-center gap-1 p-2 text-gray-400 hover:text-white transition" id="btn-orders"><i class="fas fa-box text-xl"></i><span class="text-[10px]">Orders</span></button>
        <button onclick="nav('new_order')" class="relative -top-6 bg-gradient-to-tr from-neon-blue to-neon-purple w-14 h-14 rounded-full flex items-center justify-center shadow-[0_0_20px_rgba(0,255,255,0.4)] border-4 border-[#050507] hover:scale-105 transition"><i class="fas fa-plus text-black text-xl font-bold"></i></button>
        <button onclick="nav('funds')" class="nav-btn flex flex-col items-center gap-1 p-2 text-gray-400 hover:text-white transition" id="btn-funds"><i class="fas fa-wallet text-xl"></i><span class="text-[10px]">Funds</span></button>
        <button onclick="nav('menu')" class="nav-btn flex flex-col items-center gap-1 p-2 text-gray-400 hover:text-white transition" id="btn-menu"><i class="fas fa-bars text-xl"></i><span class="text-[10px]">Menu</span></button>
    </nav>

    <!-- FLOATING CHAT -->
    <button onclick="openChat()" class="fixed bottom-24 right-4 z-40 bg-green-500 w-12 h-12 rounded-full flex items-center justify-center shadow-lg hover:scale-110 transition animate-bounce"><i class="fas fa-comment-dots text-white text-xl"></i></button>

    <!-- TOAST & MODALS -->
    <div id="toast-container" class="fixed top-20 right-4 z-[60] space-y-2 pointer-events-none"></div>
    <div id="modal-backdrop" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[70] hidden flex items-center justify-center p-4">
        <div id="modal-content" class="glass w-full max-w-md rounded-2xl p-6 relative transform transition-all scale-95 opacity-0 max-h-[90vh] overflow-y-auto"></div>
    </div>

    <!-- FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, onSnapshot, query, orderBy, where, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD2awIBade5KeMWrNcyrfYgO07FLRo_o6I",
            authDomain: "snr-smm-panel.firebaseapp.com",
            projectId: "snr-smm-panel",
            storageBucket: "snr-smm-panel.firebasestorage.app",
            messagingSenderId: "483328444446",
            appId: "1:483328444446:web:d1e348263c660d8d36060f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let state = {
            user: null, userData: null, page: 'home',
            data: { platforms: [], services: [], banners: [], myOrders: [], settings: {}, news: [] },
            cart: { serviceId: null }
        };

        // --- AUTH & SYNC ---
        onAuthStateChanged(auth, async (u) => {
            state.user = u;
            updateHeader();
            if(u) {
                onSnapshot(doc(db, `users/${u.uid}/profile/data`), (snap) => {
                    if(snap.exists()) {
                        state.userData = snap.data();
                        if(state.userData.isBlocked) { alert("Account Blocked"); signOut(auth); return; }
                        updateHeader();
                    } else {
                        setDoc(doc(db, `users/${u.uid}/profile/data`), { email: u.email, balance: 0, isVerified: false, isBlocked: false, createdAt: serverTimestamp() });
                    }
                });
                onSnapshot(query(collection(db, 'public/data/orders'), where('userId', '==', u.uid), orderBy('date', 'desc')), s => {
                    state.data.myOrders = s.docs.map(d => ({id:d.id, ...d.data()}));
                    if(state.page === 'orders') renderOrders();
                });
            }
        });

        // Fetch Global Data
        onSnapshot(collection(db, 'public/data/platforms'), s => { state.data.platforms = s.docs.map(d => ({id:d.id, ...d.data()})).sort((a,b)=>a.sortOrder-b.sortOrder); if(['home','new_order'].includes(state.page)) renderHome(); });
        onSnapshot(collection(db, 'public/data/services'), s => state.data.services = s.docs.map(d => ({id:d.id, ...d.data()})));
        onSnapshot(collection(db, 'public/data/banners'), s => { state.data.banners = s.docs.map(d => d.data()); if(state.page==='home') renderHome(); });
        onSnapshot(doc(db, 'public/data/settings/config'), s => {
            state.data.settings = s.exists() ? s.data() : {};
            applyAdminSettings();
        });

        const applyAdminSettings = () => {
            const s = state.data.settings;
            const idEl = document.getElementById('site-identity');
            if(s.siteLogo) {
                idEl.innerHTML = `<img src="${s.siteLogo}" class="w-8 h-8 rounded object-cover"> <span class="font-bold text-lg">${s.siteName || 'SNR SMM'}</span>`;
            } else if (s.siteName) {
                idEl.innerHTML = `<div class="w-8 h-8 rounded bg-gradient-to-br from-neon-blue to-neon-pink flex items-center justify-center font-bold text-black font-sans">S</div><span class="font-bold text-lg">${s.siteName}</span>`;
            }
            if(s.maintenance && state.page !== 'maintenance') {
                document.body.innerHTML = `<div class="h-screen flex items-center justify-center flex-col p-8 text-center bg-[#050507] text-white">${s.maintenanceImage ? `<img src="${s.maintenanceImage}" class="w-64 mb-6 rounded-lg shadow-2xl">` : '<i class="fas fa-tools text-6xl text-yellow-500 mb-4"></i>'}<h1 class="text-3xl font-bold mb-2">Maintenance Mode</h1><p class="text-gray-400">We are currently upgrading our servers.</p></div>`;
                state.page = 'maintenance';
            }
        };

        const updateHeader = () => {
            const h = document.getElementById('header-auth');
            if(state.user) {
                h.innerHTML = `
                    <div onclick="nav('funds')" class="flex flex-col items-end mr-2 cursor-pointer hover:opacity-80 transition">
                        <span class="text-[10px] text-gray-400">Balance <i class="fas fa-plus-circle text-neon-blue text-[8px]"></i></span>
                        <span class="font-bold text-neon-green font-mono">₹${(state.userData?.balance||0).toFixed(2)}</span>
                    </div>
                    <div onclick="nav('menu')" class="w-9 h-9 rounded-full bg-white/10 flex items-center justify-center border border-white/20 cursor-pointer overflow-hidden">
                        ${state.userData?.photoUrl ? `<img src="${state.userData.photoUrl}" class="w-full h-full object-cover">` : `<i class="fas fa-user text-xs"></i>`}
                    </div>
                `;
            } else {
                h.innerHTML = `<button onclick="openLoginModal()" class="text-xs bg-neon-blue text-black px-4 py-1.5 rounded-full font-bold shadow-[0_0_10px_rgba(0,255,255,0.5)]">Login</button>`;
            }
        };

        window.nav = (page) => {
            state.page = page;
            const content = document.getElementById('main-content');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('text-neon-blue', 'text-white'));
            const btn = document.getElementById(`btn-${page === 'new_order' ? 'home' : page}`);
            if(btn) btn.classList.add('text-neon-blue', 'text-white');
            content.innerHTML = ''; window.scrollTo(0,0);
            
            switch(page) {
                case 'home': renderHome(); break;
                case 'new_order': renderHome(); break;
                case 'orders': renderOrders(); break;
                case 'funds': renderFunds(); break;
                case 'menu': renderMenu(); break;
                case 'mass_order': renderMassOrder(); break;
                case 'auth': openLoginModal(); break;
            }
        };

        // --- VIEWS ---
        const renderHome = () => {
            const bannerHTML = state.data.banners.length > 0 ? `<div class="flex overflow-x-auto gap-4 p-4 snap-x hide-scroll">${state.data.banners.map(b => `<a href="${b.link||'#'}" class="min-w-[90%] snap-center rounded-xl overflow-hidden border border-white/10 shadow-lg aspect-[2/1]"><img src="${b.url}" class="w-full h-full object-cover"></a>`).join('')}</div>` : '';
            const plats = state.data.platforms.map(p => `
                <div onclick="selectPlatform('${p.id}')" class="glass p-3 rounded-xl flex flex-col items-center gap-2 hover:bg-white/5 transition active:scale-95 cursor-pointer border border-white/5 group">
                    <img src="${p.icon}" class="w-12 h-12 rounded-lg object-cover shadow-[0_0_15px_rgba(255,255,255,0.1)] group-hover:shadow-[0_0_15px_rgba(0,255,255,0.4)] transition">
                    <span class="text-[10px] font-medium text-gray-300 text-center leading-tight group-hover:text-white">${p.name}</span>
                </div>`).join('');

            document.getElementById('main-content').innerHTML = `
                ${bannerHTML}
                <div class="px-4 pb-2"><h2 class="text-lg font-bold text-white mb-1">Services</h2><p class="text-xs text-gray-500">Select a category</p></div>
                <div class="grid grid-cols-3 gap-3 p-4 pt-2 pb-20 page-enter">${plats}</div>
            `;
        };

        window.selectPlatform = (pid) => {
            const srvs = state.data.services.filter(s => s.platformId === pid && s.enabled);
            if(srvs.length === 0) return showToast('No services available', 'info');
            const content = srvs.map(s => `<div onclick="openServiceDetail('${s.id}')" class="glass p-3 rounded-lg mb-2 flex justify-between items-center active:bg-white/10 cursor-pointer"><div class="flex-1"><div class="flex items-center gap-2"><span class="bg-neon-blue/20 text-neon-blue text-[9px] px-1 rounded">ID: ${s.id.slice(0,4)}</span><div class="text-sm font-bold text-white line-clamp-1">${s.name}</div></div><div class="text-[10px] text-gray-400">${s.category} • ₹${s.pricePer1000}/1k</div></div><i class="fas fa-chevron-right text-xs text-gray-600"></i></div>`).join('');
            openModal(`<h3 class="font-bold text-lg mb-4 flex items-center gap-2"><img src="${state.data.platforms.find(p=>p.id===pid).icon}" class="w-6 h-6 rounded">${state.data.platforms.find(p=>p.id===pid).name}</h3><div class="space-y-2 max-h-[60vh] overflow-y-auto">${content}</div>`);
        };

        window.openServiceDetail = (sid) => {
            const s = state.data.services.find(x => x.id === sid);
            closeModal(); state.cart = { serviceId: sid };
            document.getElementById('main-content').innerHTML = `
                <div class="p-4 page-enter pb-24">
                    <button onclick="nav('home')" class="mb-4 text-gray-400 text-sm"><i class="fas fa-arrow-left"></i> Back</button>
                    <div class="glass p-6 rounded-2xl border-t border-neon-blue relative overflow-hidden">
                        <div class="absolute -top-10 -right-10 w-32 h-32 bg-neon-blue/20 blur-3xl rounded-full pointer-events-none"></div>
                        <h2 class="font-bold text-lg mb-1">${s.name}</h2>
                        <span class="text-xs text-neon-blue bg-neon-blue/10 px-2 py-0.5 rounded mb-4 inline-block">ID: ${s.id.slice(0,4)} | ${s.category}</span>
                        <div class="space-y-4">
                            <input type="text" id="ord-link" placeholder="Link URL" class="w-full input-box p-4 rounded-xl text-sm">
                            <input type="number" id="ord-qty" placeholder="Quantity (${s.min} - ${s.max})" value="${s.min}" oninput="calcPrice()" class="w-full input-box p-4 rounded-xl text-sm">
                            <div class="flex justify-between items-center bg-white/5 p-4 rounded-xl border border-white/5"><span class="text-gray-400 text-sm">Total</span><span class="text-2xl font-bold text-neon-green" id="ord-total">₹${((s.min/1000)*s.pricePer1000).toFixed(2)}</span></div>
                            ${s.notice ? `<div class="text-xs text-yellow-500 bg-yellow-500/10 p-3 rounded border border-yellow-500/20"><i class="fas fa-exclamation-triangle mr-1"></i> ${s.notice}</div>` : ''}
                            <button onclick="submitOrder()" class="w-full bg-gradient-to-r from-neon-blue to-neon-purple text-black font-bold py-4 rounded-xl shadow-[0_0_20px_rgba(0,255,255,0.3)] hover:scale-[1.02] transition">PLACE ORDER</button>
                        </div>
                    </div>
                </div>`;
            window.calcPrice = () => {
                const qty = parseInt(document.getElementById('ord-qty').value) || 0;
                document.getElementById('ord-total').innerText = `₹${((qty / 1000) * s.pricePer1000).toFixed(2)}`;
            };
        };

        window.submitOrder = async () => {
            if(!state.user) return openLoginModal();
            const link = document.getElementById('ord-link').value;
            const qty = parseInt(document.getElementById('ord-qty').value);
            const s = state.data.services.find(x => x.id === state.cart.serviceId);
            if(!link) return showToast('Link required', 'error');
            if(qty < s.min || qty > s.max) return showToast(`Qty must be ${s.min}-${s.max}`, 'error');
            const cost = (qty/1000) * s.pricePer1000;
            if((state.userData.balance || 0) < cost) return showToast('Insufficient Funds', 'error');

            try {
                await updateDoc(doc(db, `users/${state.user.uid}/profile/data`), { balance: state.userData.balance - cost });
                await addDoc(collection(db, 'public/data/orders'), {
                    userId: state.user.uid, serviceId: s.id, serviceName: s.name, platformId: s.platformId, link, quantity: qty, price: cost, status: 'Pending', date: serverTimestamp()
                });
                const animUrl = state.data.settings.animationUrl;
                if(animUrl) {
                    const overlay = document.createElement('div');
                    overlay.className = 'fixed inset-0 z-[100] bg-black/90 flex items-center justify-center flex-col';
                    overlay.innerHTML = `<img src="${animUrl}" class="w-32 h-32 object-contain mb-4 animate-pop"><h2 class="text-2xl font-bold text-white">Order Placed!</h2>`;
                    document.body.appendChild(overlay);
                    setTimeout(() => { overlay.remove(); nav('orders'); }, 2500);
                } else {
                    showToast('Order Placed!', 'success');
                    nav('orders');
                }
            } catch(e) { showToast(e.message, 'error'); }
        };

        // --- MASS ORDER ---
        const renderMassOrder = () => {
            if(!state.user) return openLoginModal();
            document.getElementById('main-content').innerHTML = `
                <div class="p-4 pb-24 page-enter">
                    <button onclick="nav('menu')" class="mb-4 text-gray-400 text-sm"><i class="fas fa-arrow-left"></i> Back</button>
                    <h2 class="text-2xl font-bold mb-4">Mass Order</h2>
                    <div class="glass p-6 rounded-2xl border-t border-neon-purple">
                        <p class="text-xs text-gray-400 mb-4">Format: <b>Service_ID | Link | Quantity</b><br>One order per line.</p>
                        <textarea id="mass-input" class="w-full input-box p-4 rounded-xl text-xs h-40 font-mono" placeholder="102 | http://link.com | 1000&#10;105 | http://link2.com | 500"></textarea>
                        <button onclick="submitMassOrder()" class="w-full bg-neon-purple text-white font-bold py-3 rounded-xl mt-4 hover:opacity-90">Submit Mass Order</button>
                    </div>
                </div>`;
        };
        
        window.submitMassOrder = async () => {
            const txt = document.getElementById('mass-input').value.trim();
            if(!txt) return;
            const lines = txt.split('\n');
            let totalCost = 0;
            let batchData = [];
            
            for(let line of lines) {
                const [sidPart, link, qtyPart] = line.split('|').map(s=>s.trim());
                if(!sidPart || !link || !qtyPart) continue;
                // Find service (matching ID string mostly)
                const s = state.data.services.find(srv => srv.id.startsWith(sidPart));
                const qty = parseInt(qtyPart);
                if(s && qty >= s.min && qty <= s.max) {
                    const cost = (qty/1000) * s.pricePer1000;
                    totalCost += cost;
                    batchData.push({
                        userId: state.user.uid, serviceId: s.id, serviceName: s.name, platformId: s.platformId, link, quantity: qty, price: cost, status: 'Pending', date: serverTimestamp()
                    });
                }
            }

            if(batchData.length === 0) return showToast('No valid lines found', 'error');
            if((state.userData.balance || 0) < totalCost) return showToast(`Need ₹${totalCost.toFixed(2)}`, 'error');

            if(confirm(`Place ${batchData.length} orders for ₹${totalCost.toFixed(2)}?`)) {
                try {
                    const batch = writeBatch(db);
                    // Deduct balance (single write for atomic simplicity in this structure)
                    await updateDoc(doc(db, `users/${state.user.uid}/profile/data`), { balance: state.userData.balance - totalCost });
                    // Add orders (loop)
                    batchData.forEach(d => addDoc(collection(db, 'public/data/orders'), d));
                    showToast('Mass Order Placed!', 'success');
                    nav('orders');
                } catch(e) { showToast(e.message, 'error'); }
            }
        };

        const renderFunds = () => {
            if(!state.user) return openLoginModal();
            const s = state.data.settings;
            const qrUrl = s.qrUrl || 'https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=upi://pay';
            document.getElementById('main-content').innerHTML = `
                <div class="p-4 pb-24 page-enter">
                    <h2 class="text-2xl font-bold mb-6">Add Funds</h2>
                    <div class="glass p-6 rounded-2xl flex flex-col items-center mb-6 text-center">
                        <div class="bg-white p-2 rounded-xl mb-4 relative group">
                            <img src="${qrUrl}" class="w-40 h-40 object-contain">
                            <a href="${qrUrl}" download="qr_code.png" target="_blank" class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition rounded-xl text-white font-bold"><i class="fas fa-download mr-2"></i> Download</a>
                        </div>
                        <p class="text-xs text-gray-400 mb-2">Scan & Pay</p>
                        <div class="flex items-center gap-2 bg-black/50 px-4 py-2 rounded-full border border-white/10 w-full justify-between"><span class="text-sm font-mono text-neon-blue truncate">${s.upiId || 'admin@upi'}</span><button onclick="navigator.clipboard.writeText('${s.upiId}');showToast('Copied','success')" class="text-gray-400 hover:text-white"><i class="fas fa-copy"></i></button></div>
                    </div>
                    <div class="glass p-6 rounded-2xl space-y-4">
                        <input type="number" id="pay-amt" placeholder="Amount (₹)" class="w-full input-box p-3 rounded-lg">
                        <input type="text" id="pay-utr" placeholder="UTR / Transaction ID" class="w-full input-box p-3 rounded-lg">
                        <button onclick="submitFund()" class="w-full bg-neon-green text-black font-bold py-3 rounded-xl">Verify Payment</button>
                    </div>
                </div>`;
        };
        window.submitFund = async () => {
            const amt = parseFloat(document.getElementById('pay-amt').value);
            const utr = document.getElementById('pay-utr').value;
            if(!amt || !utr) return showToast('Fill all details', 'error');
            try { await addDoc(collection(db, 'public/data/fund_requests'), { userId: state.user.uid, amount: amt, utr, status: 'Pending', date: serverTimestamp() }); showToast('Request Sent', 'success'); nav('home'); } catch(e){showToast(e.message,'error')}
        };

        const renderMenu = () => {
            if(!state.user) return openLoginModal();
            const u = state.userData || {};
            const menuBtn = (label, icon, act, color='text-white') => `<button onclick="${act}" class="w-full glass p-4 rounded-xl flex items-center justify-between hover:bg-white/5 transition group mb-2"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center group-hover:bg-neon-blue group-hover:text-black transition"><i class="${icon}"></i></div><span class="text-sm font-medium ${color}">${label}</span></div><i class="fas fa-chevron-right text-gray-500 text-xs"></i></button>`;
            
            document.getElementById('main-content').innerHTML = `
                <div class="p-4 pb-24 page-enter">
                    <div class="glass p-6 rounded-2xl flex items-center gap-4 mb-6 relative overflow-hidden">
                        <div class="relative w-16 h-16 group cursor-pointer" onclick="document.getElementById('profile-pic-input').click()">
                            <div class="w-full h-full rounded-full overflow-hidden border-2 border-neon-blue">
                                ${u.photoUrl ? `<img src="${u.photoUrl}" class="w-full h-full object-cover">` : `<div class="w-full h-full bg-gray-700 flex items-center justify-center text-2xl font-bold">${state.user.email[0].toUpperCase()}</div>`}
                            </div>
                            <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition rounded-full"><i class="fas fa-camera text-white"></i></div>
                        </div>
                        <input type="file" id="profile-pic-input" class="hidden" accept="image/*" onchange="uploadProfilePhoto(this)">
                        <div>
                            <h2 class="font-bold text-lg flex items-center gap-2">${state.user.email.split('@')[0]} ${u.isVerified?'<i class="fas fa-check-circle text-neon-blue text-sm"></i>':''}</h2>
                            <p class="text-xs text-gray-400">${state.user.email}</p>
                            <div class="text-neon-blue text-xs mt-1"><i class="fab fa-whatsapp"></i> ${u.whatsapp || 'No Number'}</div>
                        </div>
                    </div>
                    
                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-2 ml-1">General</h3>
                    ${menuBtn('Services Catalog', 'fas fa-list', "nav('new_order')")}
                    ${menuBtn('Mass Order', 'fas fa-layer-group', "nav('mass_order')")}
                    ${menuBtn('Updates / News', 'fas fa-bell', "openModal('<h3>News</h3><p>No new updates.</p>')")}
                    
                    <h3 class="text-xs font-bold text-gray-500 uppercase mb-2 ml-1 mt-4">Legal</h3>
                    ${menuBtn('Privacy Policy', 'fas fa-user-shield', "viewText('privacyPolicy', 'Privacy Policy')")}
                    ${menuBtn('Refund Policy', 'fas fa-undo', "viewText('refundPolicy', 'Refund Policy')")}
                    ${menuBtn('Terms & Rules', 'fas fa-gavel', "viewText('orderRules', 'Rules')")}
                    
                    <button onclick="signOut(auth);nav('home')" class="w-full glass p-4 rounded-xl flex justify-between items-center text-red-400 mt-4"><span class="flex items-center gap-3"><i class="fas fa-sign-out-alt bg-red-500/10 w-8 h-8 flex items-center justify-center rounded-full"></i> Logout</span></button>

                     <div class="mt-8 flex justify-center gap-4">
                        ${state.data.settings.whatsapp ? `<a href="${state.data.settings.whatsapp}" target="_blank" class="w-10 h-10 rounded-full glass flex items-center justify-center text-green-400"><i class="fab fa-whatsapp"></i></a>` : ''}
                        ${state.data.settings.telegram ? `<a href="${state.data.settings.telegram}" target="_blank" class="w-10 h-10 rounded-full glass flex items-center justify-center text-blue-400"><i class="fab fa-telegram"></i></a>` : ''}
                    </div>
                </div>`;
        };
        
        const renderOrders = () => {
             if(!state.user) return openLoginModal();
             const list = state.data.myOrders.map(o => `
                <div class="glass p-4 rounded-xl border-l-4 ${o.status==='Completed'?'border-neon-green':o.status==='Cancelled'?'border-red-500':'border-neon-blue'} relative overflow-hidden mb-3">
                    <div class="flex justify-between items-start mb-2"><div class="max-w-[70%]"><h3 class="font-bold text-sm text-white truncate">${o.serviceName}</h3><div class="text-[10px] text-gray-400 mt-1">${new Date(o.date?.seconds*1000).toLocaleString()}</div></div><span class="text-xs font-bold ${o.status==='Completed'?'text-neon-green':o.status==='Pending'?'text-yellow-400':'text-neon-blue'}">${o.status}</span></div>
                    <div class="bg-black/40 p-2 rounded text-xs text-gray-300 mb-2 truncate font-mono">${o.link}</div>
                    <div class="flex justify-between items-center text-xs"><span class="text-gray-400">Qty: <b class="text-white">${o.quantity}</b></span><span class="text-neon-green font-bold">₹${o.price.toFixed(2)}</span></div>
                </div>`).join('') || '<div class="text-center text-gray-500 mt-10">No orders found</div>';
             document.getElementById('main-content').innerHTML = `<div class="p-4 pb-24 page-enter"><h2 class="text-2xl font-bold mb-4">My Orders</h2>${list}</div>`;
        };

        window.uploadProfilePhoto = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const base64 = e.target.result;
                    try { await updateDoc(doc(db, `users/${state.user.uid}/profile/data`), { photoUrl: base64 }); showToast('Photo Updated', 'success'); } catch(err) { showToast('Image too large (Max 1MB)', 'error'); }
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.viewText = (key, title) => { const txt = state.data.settings[key] || 'N/A'; openModal(`<h3 class="font-bold mb-4 text-neon-blue">${title}</h3><p class="text-sm text-gray-300 whitespace-pre-wrap">${txt}</p>`); };
        
        window.openLoginModal = () => {
            openModal(`
                <div class="text-center mb-6"><h2 class="text-2xl font-bold text-white">Welcome</h2><p class="text-xs text-gray-500">Login or Register automatically</p></div>
                <div class="space-y-4">
                    <input type="email" id="log-email" placeholder="Email" class="w-full input-box p-3 rounded-xl">
                    <input type="password" id="log-pass" placeholder="Password" class="w-full input-box p-3 rounded-xl">
                    <div class="relative"><i class="fab fa-whatsapp absolute left-4 top-3.5 text-green-400"></i><input type="text" id="log-wa" placeholder="WhatsApp (Optional)" class="w-full input-box p-3 pl-10 rounded-xl"></div>
                    <button onclick="doLogin()" class="w-full bg-neon-blue text-black font-bold py-3 rounded-xl hover:shadow-[0_0_15px_#00ffff]">Continue</button>
                </div>`);
        };

        window.doLogin = async () => {
            const e = document.getElementById('log-email').value;
            const p = document.getElementById('log-pass').value;
            const wa = document.getElementById('log-wa').value;
            try { await signInWithEmailAndPassword(auth, e, p); closeModal(); showToast('Logged in!', 'success'); } catch(err) {
                 try { const cred = await createUserWithEmailAndPassword(auth, e, p); await setDoc(doc(db, `users/${cred.user.uid}/profile/data`), { email: e, balance: 0, whatsapp: wa, isVerified: false, isBlocked: false, createdAt: serverTimestamp() }); closeModal(); showToast('Account Created!', 'success'); } catch(regErr) { showToast(err.message, 'error'); }
            }
        };

        // --- UTILS ---
        window.openModal = (h) => { const m=document.getElementById('modal-content'), b=document.getElementById('modal-backdrop'); m.innerHTML=h+`<button onclick="closeModal()" class="absolute top-4 right-4 text-gray-500"><i class="fas fa-times"></i></button>`; b.classList.remove('hidden'); setTimeout(()=>{m.classList.remove('scale-95','opacity-0');m.classList.add('scale-100','opacity-100')},10); };
        window.closeModal = () => { const m=document.getElementById('modal-content'), b=document.getElementById('modal-backdrop'); m.classList.remove('scale-100','opacity-100'); m.classList.add('scale-95','opacity-0'); setTimeout(()=>b.classList.add('hidden'),300); };
        window.showToast = (msg, type) => { const c=document.getElementById('toast-container'), e=document.createElement('div'); e.className=`glass px-4 py-3 rounded-lg border-l-4 ${type==='error'?'border-red-500':'border-neon-green'} flex items-center gap-2 shadow-lg page-enter`; e.innerHTML=`<i class="fas ${type==='error'?'fa-exclamation-circle':'fa-check-circle'}"></i> <span class="text-sm font-bold">${msg}</span>`; c.appendChild(e); setTimeout(()=>e.remove(),3000); };

        // Support Chat
        window.openChat = () => { if(!state.user) return openLoginModal(); const mid=state.user.uid; openModal(`<h3 class="font-bold mb-2">Support Chat</h3><div id="chat-box" class="h-64 bg-black/50 rounded p-2 overflow-y-auto mb-2 text-xs space-y-2">Loading...</div><div class="flex gap-2"><input id="chat-msg" class="flex-1 input-box p-2 rounded text-sm" placeholder="Type..."><button onclick="sendMsg()" class="bg-neon-blue text-black px-3 rounded font-bold"><i class="fas fa-paper-plane"></i></button></div>`); const q=query(collection(db,'public/data/messages'),where('userId','==',mid),orderBy('timestamp','asc')); onSnapshot(q,(snap)=>{const box=document.getElementById('chat-box'); if(box) { box.innerHTML=snap.docs.map(d=>{const m=d.data();return `<div class="bg-white/10 p-2 rounded self-end">${m.message}</div>${m.replied?'<div class="bg-neon-blue/20 text-neon-blue p-2 rounded self-start">Reply sent via notification.</div>':''}`}).join(''); box.scrollTop=box.scrollHeight;}}); };
        window.sendMsg = async () => { const txt=document.getElementById('chat-msg').value; if(!txt)return; await addDoc(collection(db,'public/data/messages'),{userId:state.user.uid, userName:state.user.email, message:txt, timestamp:serverTimestamp(), read:false}); document.getElementById('chat-msg').value=''; };

        // Need to expose a global for 'getDocs' if needed or just init
        import { getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        nav('home');
    </script>
</body>
</html>
